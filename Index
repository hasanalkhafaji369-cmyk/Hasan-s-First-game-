import pygame
import random
import sys

# --- Configuration ---
WIDTH, HEIGHT = 480, 640
FPS = 60

PLAYER_WIDTH, PLAYER_HEIGHT = 50, 20
PLAYER_SPEED = 6

OBSTACLE_WIDTH, OBSTACLE_HEIGHT = 40, 20
OBSTACLE_BASE_SPEED = 3
SPAWN_INTERVAL_MS = 650  # ms between spawns

# --- Initialization --
pygame.init()
screen = pygame.display.set_mode((WIDTH, HEIGHT))
pygame.display.set_caption("Avoid the Falling Objects")
clock = pygame.time.Clock()
font = pygame.font.SysFont(None, 36)

SPAWN_EVENT = pygame.USEREVENT + 1
pygame.time.set_timer(SPAWN_EVENT, SPAWN_INTERVAL_MS)


def draw_text(surf, text, size, x, y, color=(255, 255, 255)):
    f = pygame.font.SysFont(None, size)
    r = f.render(text, True, color)
    rect = r.get_rect(midtop=(x, y))
    surf.blit(r, rect)


def new_player():
    return pygame.Rect(
        WIDTH // 2 - PLAYER_WIDTH // 2, HEIGHT - PLAYER_HEIGHT - 10, PLAYER_WIDTH, PLAYER_HEIGHT
    )


def spawn_obstacle():
    x = random.randint(0, WIDTH - OBSTACLE_WIDTH)
    return pygame.Rect(x, -OBSTACLE_HEIGHT, OBSTACLE_WIDTH, OBSTACLE_HEIGHT)


def game_loop():
    player = new_player()
    obstacles = []
    running = True
    game_over = False
    score = 0
    time_alive = 0.0
    obstacle_speed = OBSTACLE_BASE_SPEED

    while running:
        dt = clock.tick(FPS) / 1000.0  # seconds passed since last frame
        time_alive += dt

        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                pygame.quit()
                sys.exit()
            if event.type == SPAWN_EVENT and not game_over:
                obstacles.append(spawn_obstacle())
                # optionally make spawn quicker as time passes (simple difficulty curve)
                if time_alive > 20 and random.random() < 0.15:
                    obstacles.append(spawn_obstacle())
            if event.type == pygame.KEYDOWN and game_over:
                if event.key == pygame.K_r:
                    return  # return to restart the game

        keys = pygame.key.get_pressed()
        if not game_over:
            if keys[pygame.K_LEFT] or keys[pygame.K_a]:
                player.x -= PLAYER_SPEED
            if keys[pygame.K_RIGHT] or keys[pygame.K_d]:
                player.x += PLAYER_SPEED

            # keep player on screen
            player.x = max(0, min(WIDTH - PLAYER_WIDTH, player.x))

            # increase difficulty slowly
            obstacle_speed = OBSTACLE_BASE_SPEED + int(time_alive // 5) * 0.5

            # update obstacles
            for ob in obstacles:
                ob.y += obstacle_speed
            # remove off-screen obstacles and increase score
            alive_obstacles = []
            for ob in obstacles:
                if ob.top > HEIGHT:
                    score += 1
                else:
                    alive_obstacles.append(ob)
            obstacles = alive_obstacles

            # collision detection
            for ob in obstacles:
                if player.colliderect(ob):
                    game_over = True
                    break

        # --- Drawing ---
        screen.fill((30, 30, 40))
        # player
        pygame.draw.rect(screen, (50, 200, 50), player)
        # obstacles
        for ob in obstacles:
            pygame.draw.rect(screen, (200, 50, 50), ob)

        # HUD
        draw_text(screen, f"Score: {score}", 28, WIDTH // 2, 8)
        draw_text(screen, f"Time: {int(time_alive)}s", 24, WIDTH - 70, 8)

        if game_over:
            draw_text(screen, "GAME OVER", 56, WIDTH // 2, HEIGHT // 2 - 40, color=(255, 200, 0))
            draw_text(screen, "Press R to restart", 28, WIDTH // 2, HEIGHT // 2 + 20)

        pygame.display.flip()

    pygame.quit()


if __name__ == "__main__":
    while True:
        game_loop()
